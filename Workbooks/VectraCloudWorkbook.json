{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "tabs",
              "links": [
                {
                  "id": "6f2383c9-5b86-4365-95b4-8ac7d2321e53",
                  "cellValue": "setTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Detect",
                  "subTarget": "Detect",
                  "preText": "Detect",
                  "style": "link"
                },
                {
                  "id": "ce743dcd-55b5-42f7-8553-a9d120b1d74b",
                  "cellValue": "setTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Audit",
                  "subTarget": "Audit",
                  "style": "link"
                },
                {
                  "id": "919866f6-87e0-479f-969f-eedc7d970251",
                  "cellValue": "setTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Lockdown",
                  "subTarget": "Lockdown",
                  "style": "link"
                }
              ]
            },
            "name": "links - 0"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 11,
                  "content": {
                    "version": "LinkItem/1.0",
                    "style": "tabs",
                    "links": [
                      {
                        "id": "92ced0af-f421-44ab-9af8-b4faef3c4af7",
                        "cellValue": "setTab",
                        "linkTarget": "parameter",
                        "linkLabel": "Entity",
                        "subTarget": "Entity",
                        "style": "link"
                      },
                      {
                        "id": "592f3c92-9e4a-4b59-943f-fe239f83bdd8",
                        "cellValue": "setTab",
                        "linkTarget": "parameter",
                        "linkLabel": "Detections",
                        "subTarget": "Detections",
                        "style": "link"
                      }
                    ]
                  },
                  "name": "links - 0"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 9,
                        "content": {
                          "version": "KqlParameterItem/1.0",
                          "parameters": [
                            {
                              "id": "c2e47223-15df-44b3-8040-0bfc72eeab0a",
                              "version": "KqlParameterItem/1.0",
                              "name": "timerange",
                              "label": "Time Range",
                              "type": 4,
                              "isRequired": true,
                              "typeSettings": {
                                "selectableValues": [
                                  {
                                    "durationMs": 300000
                                  },
                                  {
                                    "durationMs": 900000
                                  },
                                  {
                                    "durationMs": 1800000
                                  },
                                  {
                                    "durationMs": 3600000
                                  },
                                  {
                                    "durationMs": 14400000
                                  },
                                  {
                                    "durationMs": 43200000
                                  },
                                  {
                                    "durationMs": 86400000
                                  },
                                  {
                                    "durationMs": 172800000
                                  },
                                  {
                                    "durationMs": 259200000
                                  },
                                  {
                                    "durationMs": 604800000
                                  },
                                  {
                                    "durationMs": 1209600000
                                  },
                                  {
                                    "durationMs": 2419200000
                                  },
                                  {
                                    "durationMs": 2592000000
                                  },
                                  {
                                    "durationMs": 5184000000
                                  },
                                  {
                                    "durationMs": 7776000000
                                  }
                                ],
                                "allowCustom": true
                              },
                              "timeContext": {
                                "durationMs": 86400000
                              },
                              "value": {
                                "durationMs": 604800000
                              }
                            },
                            {
                              "id": "f909ea8d-ce5f-41a1-8b26-d2e34169f149",
                              "version": "KqlParameterItem/1.0",
                              "name": "View",
                              "label": "Prioritized",
                              "type": 2,
                              "isRequired": true,
                              "multiSelect": true,
                              "quote": "'",
                              "delimiter": ",",
                              "typeSettings": {
                                "additionalResourceOptions": []
                              },
                              "jsonData": "[\r\n    { \"value\":\"true\", \"label\":\"Yes\" },\r\n    { \"value\":\"false\", \"label\":\"No\" }\r\n]",
                              "timeContext": {
                                "durationMs": 86400000
                              },
                              "value": [
                                "true"
                              ]
                            },
                            {
                              "id": "732ba446-ecc2-49fd-be25-53ee45d3f9c2",
                              "version": "KqlParameterItem/1.0",
                              "name": "DataSource",
                              "label": "Data Source Type",
                              "type": 2,
                              "isRequired": true,
                              "multiSelect": true,
                              "quote": "'",
                              "delimiter": ",",
                              "typeSettings": {
                                "additionalResourceOptions": [
                                  "value::all"
                                ],
                                "selectAllValue": "*",
                                "showDefault": false
                              },
                              "jsonData": "[\r\n    {\"value\":\"AWS\", \"label\":\"AWS\"},\r\n    {\"value\":\"M365/AAD\",\"label\":\"Microsoft 365/Azure AD\"},\r\n    {\"value\":\"Network\",\"label\":\"Network\"}\r\n]",
                              "defaultValue": "value::all",
                              "value": [
                                "value::all"
                              ]
                            },
                            {
                              "id": "e2fa7c64-c20c-4e7b-9557-81c64f2c5b58",
                              "version": "KqlParameterItem/1.0",
                              "name": "EntityType",
                              "label": "Entity Type",
                              "type": 2,
                              "isRequired": true,
                              "multiSelect": true,
                              "quote": "'",
                              "delimiter": ",",
                              "query": "VectraEntityScoring\r\n| where ['Last Updated'] {timerange} \r\n| summarize arg_max(['Last Updated'],*) by Name, ['Vectra Pivot']\r\n| where ('*' in ({View}) or [\"Is Prioritized\"] in ({View}))\r\n| extend source = tostring(split(Name,\":\")[0])\r\n| extend source2 = iff(isempty(source),\"NA\",source)\r\n| where ('*' in ({DataSource}) or source2 in ({DataSource}))\r\n| summarize arg_max(TimeGenerated, *) by Type\r\n| distinct ID, ['Type']\r\n| extend splitted_entity_type = split(['Type'],\"_\")\r\n| mv-expand splitted_entity_type = splitted_entity_type\r\n| extend cap = toupper(substring(splitted_entity_type,0,1)), rest_string = substring(splitted_entity_type,1)\r\n| extend joined_str = strcat(cap,rest_string)\r\n| distinct joined_str,ID,['Type']\r\n| summarize joined_array = make_list(todynamic(joined_str)) by ID, ['Type']\r\n| extend capitalized_Category = strcat_array(joined_array, \" \")\r\n| distinct ['Type'], capitalized_Category",
                              "typeSettings": {
                                "additionalResourceOptions": [
                                  "value::all"
                                ],
                                "selectAllValue": "*",
                                "showDefault": false
                              },
                              "defaultValue": "value::all",
                              "queryType": 0,
                              "resourceType": "microsoft.operationalinsights/workspaces",
                              "value": [
                                "value::all"
                              ]
                            }
                          ],
                          "style": "pills",
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces"
                        },
                        "name": "parameters - 0"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "VectraEntityScoring\r\n| where ['Last Updated'] {timerange}\r\n| summarize arg_max(['Last Updated'],*) by Name, ['Vectra Pivot']\r\n| where ('*' in ({View}) or [\"Is Prioritized\"] in ({View})) and ('*' in ({EntityType}) or Type in ({EntityType}))\r\n| extend ['Data Source Type'] = case(Name startswith \"AWS\", \"AWS\", \r\n                                        Name startswith \"SAML\", \"AWS\",\r\n                                        Name startswith \"O365\", \"M365/AAD\",\r\n                                        Name startswith \"M365\", \"M365/AAD\",\r\n                                        Name startswith \"Azure\", \"M365/AAD\",\"Network\")\r\n| where ('*' in ({DataSource}) or ['Data Source Type'] in ({DataSource}))\r\n| extend priority = case(\r\n    ['Is Prioritized'] == true, \"Prioritized\",\r\n    ['Is Prioritized'] == false, \"Not Prioritized\",\r\n    \"Unknown\"\r\n)\r\n| summarize count() by priority\r\n| order by priority desc",
                          "size": 3,
                          "title": "Entity Count by Priority",
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "visualization": "tiles",
                          "tileSettings": {
                            "titleContent": {
                              "columnMatch": "priority",
                              "formatter": 18,
                              "formatOptions": {
                                "thresholdsOptions": "colors",
                                "thresholdsGrid": [
                                  {
                                    "operator": "==",
                                    "thresholdValue": "Prioritized",
                                    "representation": "red",
                                    "text": "{0}{1}"
                                  },
                                  {
                                    "operator": "==",
                                    "thresholdValue": "Not Prioritized",
                                    "representation": "yellow",
                                    "text": "{0}{1}"
                                  },
                                  {
                                    "operator": "Default",
                                    "thresholdValue": null,
                                    "representation": "lightBlue",
                                    "text": "{0}{1}"
                                  }
                                ]
                              }
                            },
                            "leftContent": {
                              "columnMatch": "count_",
                              "formatter": 12,
                              "formatOptions": {
                                "palette": "none"
                              },
                              "numberFormat": {
                                "unit": 0,
                                "options": {
                                  "style": "decimal"
                                }
                              }
                            },
                            "showBorder": true,
                            "size": "auto"
                          }
                        },
                        "name": "query - 4"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "VectraEntityScoring\r\n| where ['Last Updated'] {timerange} \r\n| summarize arg_max(['Last Updated'],*) by Name, ['Vectra Pivot']\r\n| where ('*' in ({View}) or [\"Is Prioritized\"] in ({View})) and ('*' in ({EntityType}) or Type in ({EntityType}))\r\n| extend ['Data Source Type'] = case(Name startswith \"AWS\", \"AWS\", \r\n                                        Name startswith \"SAML\", \"AWS\",\r\n                                        Name startswith \"O365\", \"M365/AAD\",\r\n                                        Name startswith \"M365\", \"M365/AAD\",\r\n                                        Name startswith \"Azure\", \"M365/AAD\",\"Network\")\r\n| extend ['Entity Name'] = extract(\"^(AWS:|SAML:|O365:|M365:|Azure:)?(.*)$\",2, Name)\r\n| where ('*' in ({DataSource}) or ['Data Source Type'] in ({DataSource}))\r\n| sort by ['Urgency Score'] desc, Importance desc\r\n| extend Importance = case(\r\n    Importance == 0, \"Low\",\r\n    Importance == 1, \"Medium\",\r\n    Importance == 2, \"High\",\r\n    \"Unknown\"\r\n), Velocity = case(\r\n    Velocity == 0, \"Low\",\r\n    Velocity == 1, \"Medium\",\r\n    Velocity == 2, \"High\",\r\n    \"Unknown\"\r\n)\r\n| project ['Urgency Score'], Importance, ['Data Source Type'], ['Entity Name'], ['Vectra Pivot'], ['Last Updated'],  Velocity, ['Attack Rating'], ['Attack Profile']",
                          "size": 0,
                          "showAnalytics": true,
                          "title": "Entity View",
                          "showRefreshButton": true,
                          "exportFieldName": "Vectra Pivot",
                          "exportParameterName": "P_deep_url",
                          "exportDefaultValue": "None",
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "Vectra Pivot",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "Url"
                                }
                              },
                              {
                                "columnMatch": "Deep Link",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "Url"
                                }
                              }
                            ],
                            "rowLimit": 10000,
                            "filter": true
                          },
                          "sortBy": []
                        },
                        "name": "query - 3",
                        "styleSettings": {
                          "showBorder": true
                        }
                      },
                      {
                        "type": 1,
                        "content": {
                          "json": "💡 _Click on a row in the above Entity View grid to view more details_"
                        },
                        "name": "text - 8"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "VectraEntityScoring\r\n| where ['Last Updated'] {timerange} \r\n| summarize arg_max(['Last Updated'],*) by Name, ['Vectra Pivot']\r\n| where ('*' in ({View}) or [\"Is Prioritized\"] in ({View})) and ('*' in ({EntityType}) or Type in ({EntityType}))\r\n| extend ['Data Source Type'] = case(Name startswith \"AWS\", \"AWS\", \r\n                                        Name startswith \"SAML\", \"AWS\",\r\n                                        Name startswith \"O365\", \"M365/AAD\",\r\n                                        Name startswith \"M365\", \"M365/AAD\",\r\n                                        Name startswith \"Azure\", \"M365/AAD\",\"Network\")\r\n| extend ['Entity Name'] = extract(\"^(AWS:|SAML:|O365:|M365:|Azure:)?(.*)$\",2, Name)\r\n| where ('*' in ({DataSource}) or ['Data Source Type'] in ({DataSource})) and ['Vectra Pivot'] == '{P_deep_url}'\r\n| project ID, ['Entity ID'], ['Data Source Type'], ['Entity Name'], Name, Importance, ['Type'], ['Is Prioritized'], Severity, [\"Urgency Score\"], ['Vectra Pivot'], Category, ['Last Detection URL'], ['Last Detection Type'], [\"Last Detection ID\"], ['Active Detection Types'], ['Last Updated'], ['Breadth Contrib'], Velocity, ['Attack Rating'], ['Attack Profile']",
                          "size": 4,
                          "showAnalytics": true,
                          "title": "Selected Entity View data",
                          "showRefreshButton": true,
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "visualization": "table",
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "Vectra Pivot",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "Url"
                                }
                              },
                              {
                                "columnMatch": "Last Detection URL",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "Url"
                                }
                              }
                            ]
                          }
                        },
                        "conditionalVisibility": {
                          "parameterName": "P_deep_url",
                          "comparison": "isNotEqualTo",
                          "value": "None"
                        },
                        "name": "query - 7",
                        "styleSettings": {
                          "showBorder": true
                        }
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "VectraDetections\r\n| where ['Last Updated'] {timerange} and URL == '{P_deep_url}'\r\n| summarize arg_max(['Last Updated'],*) by ['Detection Name']\r\n| extend ['Data Source Type'] = case(['Entity UID'] startswith \"AWS\", \"AWS\", \r\n                                        ['Entity UID'] startswith \"SAML\", \"AWS\",\r\n                                        ['Entity UID'] startswith \"O365\", \"M365/AAD\",\r\n                                        ['Entity UID'] startswith \"M365\", \"M365/AAD\",\r\n                                        ['Entity UID'] startswith \"Azure\", \"M365/AAD\",\"Network\")\r\n| extend ['Entity Name'] = extract(\"^(AWS:|SAML:|O365:|M365:|Azure:)?(.*)$\",2,['Entity UID'])\r\n| extend ['Detection Category'] = case(['Detection Category']==\"botnet\",\"Botnet\",['Detection Category']==\"command_and_control\",\"Command and Control\",['Detection Category']==\"reconnaissance\",\"Reconnaissance\",['Detection Category']==\"lateral_movement\",\"Lateral Movement\",['Detection Category']==\"exfiltration\",\"Exfiltration\",\"Unknown\")\r\n| extend [\"Detection Details\"] = parse_json([\"Detection Details\"])\r\n| extend [\"Detection Details\"] = bag_pack(\"event_name\",[\"Detection Details\"][0].event_name,\"event_id\",[\"Detection Details\"][0].event_id,\"account_id\",[\"Detection Details\"][0].account_id,\"src_external_host\",[\"Detection Details\"][0].src_external_host)\r\n| project ['Last Updated'], ['Entity ID'], ['Detection Name'], ['Data Source Type'], ['Entity Name'], ['Vectra Pivot'], ['Is Triaged'], ['Detection Category'], Severity, ['Detection Details']\r\n| sort by ['Last Updated'] desc",
                          "size": 0,
                          "showAnalytics": true,
                          "title": "Detection List",
                          "showRefreshButton": true,
                          "exportFieldName": "Vectra Pivot",
                          "exportParameterName": "P_detection_url",
                          "exportDefaultValue": "None",
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "Vectra Pivot",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "Url"
                                }
                              },
                              {
                                "columnMatch": "Detection Details",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "CellDetails",
                                  "linkIsContextBlade": true
                                }
                              },
                              {
                                "columnMatch": "Deep Link",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "Url"
                                }
                              }
                            ],
                            "rowLimit": 10000,
                            "filter": true
                          },
                          "sortBy": []
                        },
                        "conditionalVisibility": {
                          "parameterName": "P_deep_url",
                          "comparison": "isNotEqualTo",
                          "value": "None"
                        },
                        "name": "query - 4",
                        "styleSettings": {
                          "showBorder": true
                        }
                      },
                      {
                        "type": 1,
                        "content": {
                          "json": "💡 _Click on a row in the above Detection List grid to view more details_"
                        },
                        "conditionalVisibility": {
                          "parameterName": "P_deep_url",
                          "comparison": "isNotEqualTo",
                          "value": "None"
                        },
                        "name": "text - 9"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "VectraDetections\r\n| where ['Last Updated'] {timerange} and URL == '{P_deep_url}'\r\n| summarize arg_max(['Last Updated'],*) by ['Detection Name']\r\n| where ['Vectra Pivot'] == '{P_detection_url}'\r\n| extend ['Detection Category'] = case(['Detection Category']==\"botnet\",\"Botnet\",['Detection Category']==\"command_and_control\",\"Command and Control\",['Detection Category']==\"reconnaissance\",\"Reconnaissance\",['Detection Category']==\"lateral_movement\",\"Lateral Movement\",['Detection Category']==\"exfiltration\",\"Exfiltration\",\"Unknown\")\r\n| extend [\"Detection Details\"] = parse_json([\"Detection Details\"])[0]\r\n| project ID, ['Detection Category'], Threat, Certainty, ['Is Triaged'], [\"Detection Name\"], [\"D Type Vname\"], [\"Detection ID\"], [\"Vectra Pivot\"], [\"Entity ID\"], URL, [\"Entity UID\"], [\"Last Updated\"], [\"Detection Details\"], Severity",
                          "size": 4,
                          "showAnalytics": true,
                          "title": "Selected Detection List Data",
                          "showRefreshButton": true,
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "visualization": "table",
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "Vectra Pivot",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "Url"
                                }
                              },
                              {
                                "columnMatch": "URL",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "Url"
                                }
                              },
                              {
                                "columnMatch": "Detection Details",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "CellDetails",
                                  "linkIsContextBlade": true
                                }
                              }
                            ]
                          }
                        },
                        "conditionalVisibilities": [
                          {
                            "parameterName": "P_deep_url",
                            "comparison": "isNotEqualTo",
                            "value": "None"
                          },
                          {
                            "parameterName": "P_detection_url",
                            "comparison": "isNotEqualTo",
                            "value": "None"
                          }
                        ],
                        "name": "query - 7",
                        "styleSettings": {
                          "showBorder": true
                        }
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "setTab",
                    "comparison": "isEqualTo",
                    "value": "Entity"
                  },
                  "name": "Entity"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 9,
                        "content": {
                          "version": "KqlParameterItem/1.0",
                          "parameters": [
                            {
                              "id": "8ba900f4-2667-4651-87ee-866de79ed08f",
                              "version": "KqlParameterItem/1.0",
                              "name": "TimeRange",
                              "label": "Time Range",
                              "type": 4,
                              "isRequired": true,
                              "typeSettings": {
                                "selectableValues": [
                                  {
                                    "durationMs": 300000
                                  },
                                  {
                                    "durationMs": 900000
                                  },
                                  {
                                    "durationMs": 1800000
                                  },
                                  {
                                    "durationMs": 3600000
                                  },
                                  {
                                    "durationMs": 14400000
                                  },
                                  {
                                    "durationMs": 43200000
                                  },
                                  {
                                    "durationMs": 86400000
                                  },
                                  {
                                    "durationMs": 172800000
                                  },
                                  {
                                    "durationMs": 259200000
                                  },
                                  {
                                    "durationMs": 604800000
                                  },
                                  {
                                    "durationMs": 1209600000
                                  },
                                  {
                                    "durationMs": 2419200000
                                  },
                                  {
                                    "durationMs": 2592000000
                                  },
                                  {
                                    "durationMs": 5184000000
                                  },
                                  {
                                    "durationMs": 7776000000
                                  }
                                ],
                                "allowCustom": true
                              },
                              "timeContext": {
                                "durationMs": 86400000
                              },
                              "value": {
                                "durationMs": 604800000
                              }
                            },
                            {
                              "id": "41b0ee6f-04db-423c-a0fd-babfda10e619",
                              "version": "KqlParameterItem/1.0",
                              "name": "DataSource",
                              "label": "Data Source Type",
                              "type": 2,
                              "isRequired": true,
                              "multiSelect": true,
                              "quote": "'",
                              "delimiter": ",",
                              "typeSettings": {
                                "additionalResourceOptions": [
                                  "value::all"
                                ],
                                "selectAllValue": "*",
                                "showDefault": false
                              },
                              "jsonData": "[\r\n    {\"value\":\"AWS\", \"label\":\"AWS\"},\r\n    {\"value\":\"M365/AAD\",\"label\":\"Microsoft 365/Azure AD\"},\r\n    {\"value\":\"Network\",\"label\":\"Network\"}\r\n]",
                              "defaultValue": "value::all",
                              "value": [
                                "value::all"
                              ]
                            },
                            {
                              "id": "bd9a1ea9-0bec-457d-a24b-f84e15e1af42",
                              "version": "KqlParameterItem/1.0",
                              "name": "DetectionCategory",
                              "label": "Detection Category",
                              "type": 2,
                              "isRequired": true,
                              "multiSelect": true,
                              "quote": "'",
                              "delimiter": ",",
                              "typeSettings": {
                                "additionalResourceOptions": [
                                  "value::all"
                                ],
                                "selectAllValue": "*",
                                "showDefault": false
                              },
                              "jsonData": "[\r\n    {\"value\":\"botnet\", \"label\":\"Botnet\"},\r\n    {\"value\":\"command_and_control\",\"label\":\"Command and Control\"},\r\n    {\"value\":\"reconnaissance\",\"label\":\"Reconnaissance\"},\r\n    {\"value\":\"lateral_movement\",\"label\":\"Lateral Movement\"},\r\n    {\"value\":\"exfiltration\",\"label\":\"Exfiltration\"}\r\n]",
                              "defaultValue": "value::all",
                              "value": [
                                "value::all"
                              ]
                            },
                            {
                              "id": "1144f1b6-24e0-422c-bc8c-9bd87f6d258e",
                              "version": "KqlParameterItem/1.0",
                              "name": "DetectionType",
                              "label": "Detection Name",
                              "type": 2,
                              "isRequired": true,
                              "multiSelect": true,
                              "quote": "'",
                              "delimiter": ",",
                              "query": "VectraDetections\r\n| where ['Last Updated'] {TimeRange}\r\n| summarize arg_max(['Last Updated'],*) by ['Detection Name'], URL\r\n| extend source = tostring(split(['Entity UID'],\":\")[0])\r\n| where ('*' in ({DataSource}) or source in ({DataSource})) and ('*' in ({DetectionCategory}) or ['Detection Category'] in ({DetectionCategory}))\r\n| distinct ['Detection Name']\r\n| sort by ['Detection Name'] asc",
                              "typeSettings": {
                                "additionalResourceOptions": [
                                  "value::all"
                                ],
                                "selectAllValue": "*",
                                "showDefault": false
                              },
                              "defaultValue": "value::all",
                              "queryType": 0,
                              "resourceType": "microsoft.operationalinsights/workspaces",
                              "value": [
                                "value::all"
                              ]
                            }
                          ],
                          "style": "pills",
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces"
                        },
                        "name": "parameters - 0"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "datatable (Count:long, ['Detection Category']:string, category_count:long) [0,\"Botnet\",1, 0,\"Command and Control\",2, 0,\"Reconnaissance\",3, 0,\"Lateral Movement\",4, 0,\"Exfiltration\",5]\r\n|union\r\n(\r\nVectraDetections\r\n| where ['Last Updated'] {TimeRange}\r\n| summarize arg_max(['Last Updated'],*) by ['Detection Name'], URL\r\n| extend ['Data Source Type'] = case(['Entity UID'] startswith \"AWS\", \"AWS\", \r\n                                        ['Entity UID'] startswith \"SAML\", \"AWS\",\r\n                                        ['Entity UID'] startswith \"O365\", \"M365/AAD\",\r\n                                        ['Entity UID'] startswith \"M365\", \"M365/AAD\",\r\n                                        ['Entity UID'] startswith \"Azure\", \"M365/AAD\",\"Network\")\r\n| where ('*' in ({DataSource}) or ['Data Source Type'] in ({DataSource}))\r\n| where ('*' in ({DetectionCategory}) or ['Detection Category'] in ({DetectionCategory})) and ('*' in ({DetectionType}) or ['Detection Name'] in ({DetectionType}))\r\n| extend ['Detection Category'] = case(['Detection Category']==\"botnet\",\"Botnet\",['Detection Category']==\"command_and_control\",\"Command and Control\",['Detection Category']==\"reconnaissance\",\"Reconnaissance\",['Detection Category']==\"lateral_movement\",\"Lateral Movement\",['Detection Category']==\"exfiltration\",\"Exfiltration\",\"Unknown\")\r\n| extend category_count=case(['Detection Category']==\"Botnet\",1,['Detection Category']==\"Command and Control\",2,['Detection Category']==\"Reconnaissance\",3,['Detection Category']==\"Lateral Movement\",4,['Detection Category']==\"Exfiltration\",5,6)\r\n| summarize Count=count() by ['Detection Category'], category_count\r\n)\r\n| summarize Count=sum(Count) by ['Detection Category'], category_count\r\n| sort by category_count asc",
                          "size": 3,
                          "title": "Detection Category Count",
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "visualization": "tiles",
                          "tileSettings": {
                            "titleContent": {
                              "columnMatch": "Detection Category",
                              "formatter": 18,
                              "formatOptions": {
                                "thresholdsOptions": "colors",
                                "thresholdsGrid": [
                                  {
                                    "operator": "==",
                                    "thresholdValue": "Command and Control",
                                    "representation": "yellow",
                                    "text": "{0}{1}"
                                  },
                                  {
                                    "operator": "==",
                                    "thresholdValue": "Exfiltration",
                                    "representation": "purple",
                                    "text": "{0}{1}"
                                  },
                                  {
                                    "operator": "==",
                                    "thresholdValue": "Lateral Movement",
                                    "representation": "red",
                                    "text": "{0}{1}"
                                  },
                                  {
                                    "operator": "==",
                                    "thresholdValue": "Reconnaissance",
                                    "representation": "green",
                                    "text": "{0}{1}"
                                  },
                                  {
                                    "operator": "==",
                                    "thresholdValue": "Info",
                                    "representation": "gray",
                                    "text": "{0}{1}"
                                  },
                                  {
                                    "operator": "Default",
                                    "thresholdValue": null,
                                    "representation": "lightBlue",
                                    "text": "{0}{1}"
                                  }
                                ]
                              }
                            },
                            "leftContent": {
                              "columnMatch": "Count",
                              "formatter": 12,
                              "formatOptions": {
                                "palette": "none"
                              }
                            },
                            "showBorder": true,
                            "size": "auto"
                          }
                        },
                        "name": "query - 1"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "VectraDetections\r\n| where ['Last Updated'] {TimeRange}\r\n| summarize arg_max(['Last Updated'],*) by ['Detection Name'], URL\r\n| extend ['Data Source Type'] = case(['Entity UID'] startswith \"AWS\", \"AWS\", \r\n                                        ['Entity UID'] startswith \"SAML\", \"AWS\",\r\n                                        ['Entity UID'] startswith \"O365\", \"M365/AAD\",\r\n                                        ['Entity UID'] startswith \"M365\", \"M365/AAD\",\r\n                                        ['Entity UID'] startswith \"Azure\", \"M365/AAD\",\"Network\")\r\n| extend ['Entity Name'] = extract(\"^(AWS:|SAML:|O365:|M365:|Azure:)?(.*)$\",2,['Entity UID'])\r\n| where ('*' in ({DataSource}) or ['Data Source Type'] in ({DataSource}))\r\n| where ('*' in ({DetectionCategory}) or ['Detection Category'] in ({DetectionCategory})) and ('*' in ({DetectionType}) or ['Detection Name'] in ({DetectionType}))\r\n| extend ['Detection Category'] = case(['Detection Category']==\"botnet\",\"Botnet\",['Detection Category']==\"command_and_control\",\"Command and Control\",['Detection Category']==\"reconnaissance\",\"Reconnaissance\",['Detection Category']==\"lateral_movement\",\"Lateral Movement\",['Detection Category']==\"exfiltration\",\"Exfiltration\",\"Unknown\")\r\n| extend [\"Detection Details\"] = parse_json([\"Detection Details\"])\r\n| extend [\"Detection Details\"] = bag_pack(\"event_name\",[\"Detection Details\"][0].event_name,\"event_id\",[\"Detection Details\"][0].event_id,\"account_id\",[\"Detection Details\"][0].account_id,\"src_external_host\",[\"Detection Details\"][0].src_external_host)\r\n| project ['Last Updated'], ['Entity ID'], ['Detection Name'], ['Data Source Type'], ['Entity Name'], ['Vectra Pivot'], ['Is Triaged'], ['Detection Category'], Severity, [\"Detection Details\"], ['Source IP']\r\n| sort by ['Last Updated'] desc",
                          "size": 0,
                          "showAnalytics": true,
                          "title": "Detection View",
                          "showRefreshButton": true,
                          "exportFieldName": "Vectra Pivot",
                          "exportParameterName": "P_detection_link",
                          "exportDefaultValue": "None",
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "Vectra Pivot",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "Url"
                                }
                              },
                              {
                                "columnMatch": "Detection Details",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "CellDetails",
                                  "linkIsContextBlade": true
                                }
                              }
                            ],
                            "rowLimit": 10000,
                            "filter": true
                          }
                        },
                        "name": "query - 2",
                        "styleSettings": {
                          "showBorder": true
                        }
                      },
                      {
                        "type": 1,
                        "content": {
                          "json": "💡 _Click on a row in the above Detection View grid to view more details_"
                        },
                        "name": "text - 3"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "VectraDetections\r\n| where ['Last Updated'] {TimeRange}\r\n| summarize arg_max(['Last Updated'],*) by ['Detection Name'], URL\r\n| extend ['Data Source Type'] = case(['Entity UID'] startswith \"AWS\", \"AWS\", \r\n                                        ['Entity UID'] startswith \"SAML\", \"AWS\",\r\n                                        ['Entity UID'] startswith \"O365\", \"M365/AAD\",\r\n                                        ['Entity UID'] startswith \"M365\", \"M365/AAD\",\r\n                                        ['Entity UID'] startswith \"Azure\", \"M365/AAD\",\"Network\")\r\n| where ('*' in ({DataSource}) or ['Data Source Type'] in ({DataSource}))\r\n| where ('*' in ({DetectionCategory}) or ['Detection Category'] in ({DetectionCategory})) and ('*' in ({DetectionType}) or ['Detection Name'] in ({DetectionType})) and ['Vectra Pivot'] == '{P_detection_link}'\r\n| extend ['Detection Category'] = case(['Detection Category']==\"botnet\",\"Botnet\",['Detection Category']==\"command_and_control\",\"Command and Control\",['Detection Category']==\"reconnaissance\",\"Reconnaissance\",['Detection Category']==\"lateral_movement\",\"Lateral Movement\",['Detection Category']==\"exfiltration\",\"Exfiltration\",\"Unknown\")\r\n| extend [\"Detection Details\"] = parse_json([\"Detection Details\"])[0]\r\n| project ID, ['Detection Category'], Threat, Certainty, ['Is Triaged'], [\"Detection Name\"], [\"D Type Vname\"], [\"Detection ID\"], [\"Vectra Pivot\"], [\"Entity ID\"], URL, [\"Entity UID\"], [\"Last Updated\"], [\"Detection Details\"], Severity, ['Source IP']",
                          "size": 4,
                          "showAnalytics": true,
                          "title": "Selected Detection View Data",
                          "showRefreshButton": true,
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "visualization": "table",
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "Vectra Pivot",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "Url"
                                }
                              },
                              {
                                "columnMatch": "URL",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "Url"
                                }
                              },
                              {
                                "columnMatch": "Detection Details",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "CellDetails",
                                  "linkIsContextBlade": true
                                }
                              }
                            ]
                          }
                        },
                        "conditionalVisibility": {
                          "parameterName": "P_detection_link",
                          "comparison": "isNotEqualTo",
                          "value": "None"
                        },
                        "name": "query - 4",
                        "styleSettings": {
                          "showBorder": true
                        }
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "setTab",
                    "comparison": "isEqualTo",
                    "value": "Detections"
                  },
                  "name": "Detections"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "📝 ***Refresh the web page to fetch details of recently collected events***"
                  },
                  "name": "text - 3"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "setTab",
              "comparison": "isEqualTo",
              "value": "Detect"
            },
            "name": "detect"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "9b914837-bb6a-4932-92ce-9671341c2e55",
                        "version": "KqlParameterItem/1.0",
                        "name": "TimeRange",
                        "label": "Time Range",
                        "type": 4,
                        "isRequired": true,
                        "typeSettings": {
                          "selectableValues": [
                            {
                              "durationMs": 300000
                            },
                            {
                              "durationMs": 900000
                            },
                            {
                              "durationMs": 1800000
                            },
                            {
                              "durationMs": 3600000
                            },
                            {
                              "durationMs": 14400000
                            },
                            {
                              "durationMs": 43200000
                            },
                            {
                              "durationMs": 86400000
                            },
                            {
                              "durationMs": 172800000
                            },
                            {
                              "durationMs": 259200000
                            },
                            {
                              "durationMs": 604800000
                            },
                            {
                              "durationMs": 1209600000
                            },
                            {
                              "durationMs": 2419200000
                            },
                            {
                              "durationMs": 2592000000
                            },
                            {
                              "durationMs": 5184000000
                            },
                            {
                              "durationMs": 7776000000
                            }
                          ],
                          "allowCustom": true
                        },
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "value": {
                          "durationMs": 604800000
                        }
                      },
                      {
                        "id": "faf02ab6-e28d-4d11-84d7-3039ae73bb37",
                        "version": "KqlParameterItem/1.0",
                        "name": "ResultStatus",
                        "label": "Result Status",
                        "type": 2,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "jsonData": "[\r\n    { \"value\":\"success\", \"label\":\"Success\", \"selected\":true },\r\n    { \"value\":\"failure\", \"label\":\"Failure\" },\r\n    {\"value\":\"\",\"label\":\"N/A\"}\r\n]",
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "value": [
                          "success"
                        ]
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "parameters - 2"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "VectraAudits\r\n| where ['Event Timestamp'] {TimeRange}\r\n| summarize arg_max(TimeGenerated,*) by ID\r\n| where ('*' in ({ResultStatus}) or Status in ({ResultStatus}))\r\n| extend Status = tolower(Status)\r\n| extend Result_status = case(\r\n    Status == \"success\", \"Success\",\r\n    Status == \"failure\", \"Failure\",\r\n    Status == \"\",\"N/A\"\r\n    ,\"Unknown\"\r\n)\r\n| extend importance = case(\r\n    Result_status == \"Success\", 0,\r\n    Result_status == \"Failure\", 1,\r\n    Result_status == \"NA\",2\r\n    ,3\r\n)\r\n| summarize count() by Result_status, importance\r\n| sort by importance asc",
                    "size": 3,
                    "title": "Audit Logs Count",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Result_status",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Success",
                              "representation": "green",
                              "text": "{0}{1}"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "Failure",
                              "representation": "red",
                              "text": "{0}{1}"
                            },
                            {
                              "operator": "==",
                              "thresholdValue": "NA",
                              "representation": "gray",
                              "text": "{0}{1}"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "lightBlue",
                              "text": "{0}{1}"
                            }
                          ]
                        }
                      },
                      "leftContent": {
                        "columnMatch": "count_",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "none"
                        }
                      },
                      "showBorder": true,
                      "size": "auto"
                    }
                  },
                  "name": "query - 2"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "VectraAudits\r\n| where ['Event Timestamp'] {TimeRange}\r\n| summarize arg_max(TimeGenerated,*) by ID\r\n| where ('*' in ({ResultStatus}) or Status in ({ResultStatus}))\r\n| extend ['Event Data'] = parse_json(['Event Data'])[0]\r\n| project-rename Role = ['User Role']\r\n| project ['Event Timestamp'], Username, Role, ['Source IP'], Message, Status, ['Event Data']\r\n| sort by ['Event Timestamp'] desc",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Audit View",
                    "showRefreshButton": true,
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Event Data",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "CellDetails",
                            "linkIsContextBlade": true
                          }
                        }
                      ],
                      "rowLimit": 10000,
                      "filter": true
                    }
                  },
                  "name": "query - 3",
                  "styleSettings": {
                    "showBorder": true
                  }
                },
                {
                  "type": 1,
                  "content": {
                    "json": "📝 ***Refresh the web page to fetch details of recently collected events***"
                  },
                  "name": "text - 3"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "setTab",
              "comparison": "isEqualTo",
              "value": "Audit"
            },
            "name": "audit",
            "styleSettings": {
              "margin": "10px"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "ea3f10f3-aa7e-481c-9d4f-7939d1a463a1",
                        "version": "KqlParameterItem/1.0",
                        "name": "TimeRange",
                        "label": "Time Range",
                        "type": 4,
                        "isRequired": true,
                        "typeSettings": {
                          "selectableValues": [
                            {
                              "durationMs": 300000
                            },
                            {
                              "durationMs": 900000
                            },
                            {
                              "durationMs": 1800000
                            },
                            {
                              "durationMs": 3600000
                            },
                            {
                              "durationMs": 14400000
                            },
                            {
                              "durationMs": 43200000
                            },
                            {
                              "durationMs": 86400000
                            },
                            {
                              "durationMs": 172800000
                            },
                            {
                              "durationMs": 259200000
                            },
                            {
                              "durationMs": 604800000
                            },
                            {
                              "durationMs": 1209600000
                            },
                            {
                              "durationMs": 2419200000
                            },
                            {
                              "durationMs": 2592000000
                            },
                            {
                              "durationMs": 5184000000
                            },
                            {
                              "durationMs": 7776000000
                            }
                          ],
                          "allowCustom": true
                        },
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "value": {
                          "durationMs": 604800000
                        }
                      },
                      {
                        "id": "7df89745-bea2-4a36-9c0a-4e64a01a0423",
                        "version": "KqlParameterItem/1.0",
                        "name": "EntityType",
                        "label": "Entity Type",
                        "type": 2,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "VectraLockdown\r\n| where [\"Locked Date\"] {TimeRange} or [\"Unlock Date\"] {TimeRange}\r\n| distinct Type\r\n| extend cap = toupper(substring(Type,0,1)), rest_string = substring(Type,1)\r\n| extend Captilized_type = strcat(cap,rest_string)\r\n| distinct ['Type'], Captilized_type",
                        "typeSettings": {
                          "additionalResourceOptions": [
                            "value::all"
                          ],
                          "selectAllValue": "*",
                          "showDefault": false
                        },
                        "defaultValue": "value::all",
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      },
                      {
                        "id": "90c8487a-b24b-420e-8a70-73baad8d3301",
                        "version": "KqlParameterItem/1.0",
                        "name": "EntityLocked",
                        "label": "Entity Locked",
                        "type": 2,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "jsonData": "[\r\n    { \"value\":\"True\", \"label\":\"True\", \"selected\":true },\r\n    { \"value\":\"False\", \"label\":\"False\"}\r\n]"
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "parameters - 0"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "VectraLockdown\r\n| where [\"Locked Date\"] {TimeRange} or ([\"Unlock Date\"] {TimeRange} and [\"Unlock Date\"] <= now())\r\n| summarize arg_max(TimeGenerated,*) by [\"Entity Name\"], Type, [\"Locked Date\"], [\"Unlock Date\"], [\"Locked By\"]\r\n| where ('*' in ({EntityType}) or Type in ({EntityType}))\r\n| extend current_status = case([\"Locked Date\"] <= now() and now() < [\"Unlock Date\"], \"True\", \"False\")\r\n| where ('*' in ({EntityLocked}) or current_status in ({EntityLocked}))\r\n| sort by [\"Locked Date\"] desc\r\n| project [\"Entity Name\"], [\"Entity Type\"] = Type, [\"Entity Locked\"] = current_status, [\"Locked By\"], [\"Locked Date\"], [\"Unlock Date\"]",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Lockdown View",
                    "showRefreshButton": true,
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "gridSettings": {
                      "rowLimit": 10000,
                      "filter": true
                    }
                  },
                  "name": "query - 1",
                  "styleSettings": {
                    "showBorder": true
                  }
                },
                {
                  "type": 1,
                  "content": {
                    "json": "📝 ***Refresh the web page to fetch details of recently collected events***"
                  },
                  "name": "text - 2"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "setTab",
              "comparison": "isEqualTo",
              "value": "Lockdown"
            },
            "name": "lockdown"
          }
        ]
      },
      "name": "main"
    }
  ],
  "fromTemplateId": "sentinel-VectraCloudWorkbook",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}